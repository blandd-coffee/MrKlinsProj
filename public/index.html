<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Salary Comparison Tool</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <style>
      :root {
        --primary-color: #1a237e;
        --secondary-color: #283593;
        --accent-color: #2196f3;
        --accent-light: #42a5f5;
        --success-color: #4caf50;
        --danger-color: #f44336;
        --warning-color: #ff9800;
        --neutral-color: #757575;
        --bg-color: #f5f7fa;
        --card-bg: #ffffff;
        --border-radius: 8px;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
      }

      * {
        transition: all 0.15s ease;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        padding: 24px;
        background: var(--bg-color);
        color: var(--primary-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        min-height: 100vh;
      }

      .container-main {
        max-width: 1600px;
      }

      .page-header {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--secondary-color) 100%
        );
        color: white;
        padding: 40px 30px;
        border-radius: var(--border-radius);
        margin-bottom: 40px;
        box-shadow: var(--shadow-lg);
      }

      .page-header h1 {
        font-weight: 700;
        margin-bottom: 8px;
        font-size: 2.8rem;
        letter-spacing: -0.5px;
      }

      .page-header p {
        opacity: 0.95;
        margin-bottom: 0;
        font-size: 1.05rem;
        font-weight: 300;
        letter-spacing: 0.3px;
      }

      .table-container {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        padding: 28px;
        margin-bottom: 28px;
        border-left: 4px solid var(--accent-color);
        transition: all 0.3s ease;
      }

      .table-container:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
      }

      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 28px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--bg-color);
      }

      .table-header h3 {
        color: var(--primary-color);
        font-weight: 700;
        margin-bottom: 0;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 12px;
        letter-spacing: -0.3px;
      }

      .table-header h3 i {
        color: var(--accent-color);
        font-size: 1.8rem;
      }

      table {
        margin-bottom: 0;
        width: 100%;
      }

      table thead tr {
        background: linear-gradient(135deg, #f8f9fa 0%, #f5f7fa 100%);
        border-bottom: 2px solid var(--accent-color);
      }

      table thead th {
        background: none;
        color: var(--primary-color);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
        padding: 16px 15px;
        border: none;
        text-align: left;
      }

      table tbody tr {
        cursor: pointer;
        border-bottom: 1px solid #eeeeee;
        transition: all 0.2s ease;
      }

      table tbody td {
        padding: 16px 15px;
        vertical-align: middle;
        color: var(--primary-color);
        font-weight: 500;
      }

      table tbody tr:hover {
        background-color: #f5f9ff;
        transform: translateX(2px);
      }

      table tbody tr.selected {
        background: linear-gradient(90deg, #e3f2fd 0%, #f1f7ff 100%);
        font-weight: 600;
        box-shadow: inset 4px 0 0 var(--accent-color);
        border-left: 4px solid var(--accent-color);
      }

      .form-select,
      .form-label {
        color: var(--primary-color);
      }

      .form-select {
        border: 1.5px solid #e0e0e0;
        border-radius: var(--border-radius);
        padding: 12px 14px;
        font-weight: 500;
        background-color: white;
        font-size: 0.95rem;
      }

      .form-select:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        outline: none;
      }

      .form-label {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 8px;
        color: var(--primary-color);
        text-transform: capitalize;
        letter-spacing: 0.2px;
      }

      .comparison-section {
        margin-top: 40px;
        animation: slideInUp 0.4s ease;
      }

      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .loading {
        display: none;
        text-align: center;
        padding: 60px 20px;
      }

      .loading.active {
        display: block;
      }

      .spinner-border {
        color: var(--accent-color);
        width: 3rem;
        height: 3rem;
        border-width: 3px;
      }

      .error-message {
        display: none;
        border-left: 4px solid var(--danger-color);
        background-color: #ffebee;
        color: #c62828;
        padding: 16px 20px;
        margin-bottom: 16px;
        border-radius: var(--border-radius);
        font-weight: 500;
        font-size: 0.95rem;
      }

      .error-message.active {
        display: block;
        animation: shake 0.5s ease;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      .diff-positive {
        background-color: #e8f5e9;
        color: #2e7d32;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-block;
      }

      .diff-negative {
        background-color: #ffebee;
        color: #c62828;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-block;
      }

      .diff-neutral {
        background-color: #fff3e0;
        color: #e65100;
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-block;
      }

      .diff-zero {
        background-color: #eceff1;
        color: #37474f;
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-block;
      }

      .selection-info {
        background: linear-gradient(135deg, #e3f2fd 0%, #f1f7ff 100%);
        border-left: 4px solid var(--accent-color);
        padding: 18px 20px;
        margin-bottom: 20px;
        border-radius: var(--border-radius);
        font-weight: 500;
        color: #1565c0;
        font-size: 0.95rem;
      }

      .selection-info strong {
        color: var(--primary-color);
        font-weight: 700;
      }

      .side-by-side {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 28px;
      }

      @media (max-width: 1024px) {
        .side-by-side {
          grid-template-columns: 1fr;
        }
        .page-header h1 {
          font-size: 2.2rem;
        }
      }

      .step-selector-group {
        background: var(--bg-color);
        padding: 24px;
        border-radius: var(--border-radius);
        margin-bottom: 24px;
        border: 1px solid #e0e0e0;
      }

      .step-selector-group h5 {
        color: var(--primary-color);
        font-weight: 700;
        margin-bottom: 16px;
        font-size: 1.05rem;
        text-transform: capitalize;
        letter-spacing: 0.2px;
      }

      table tbody tr.no-data {
        text-align: center;
        color: var(--neutral-color);
        font-style: italic;
      }

      .data-status {
        font-size: 0.85rem;
        color: var(--neutral-color);
        margin-top: 12px;
        font-weight: 500;
      }

      .badge-info {
        background-color: var(--accent-color);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        letter-spacing: 0.3px;
      }

      .diff-plus-symbol {
        font-weight: 700;
      }

      .diff-plus-symbol::before {
        content: "+ ";
        margin-right: 3px;
        color: var(--success-color);
        font-weight: 800;
      }

      .diff-minus-symbol {
        font-weight: 700;
      }

      .diff-minus-symbol::before {
        content: "âˆ’ ";
        margin-right: 3px;
        color: var(--danger-color);
        font-weight: 800;
      }

      .column-checkbox {
        display: none;
      }

      .column-mapping-section {
        background: var(--bg-color);
        padding: 24px;
        border-radius: var(--border-radius);
        margin-bottom: 24px;
        border: 2px solid var(--accent-light);
      }

      .column-mapping-section h5 {
        color: var(--primary-color);
        font-weight: 700;
        margin-bottom: 16px;
        font-size: 1.05rem;
        text-transform: capitalize;
        letter-spacing: 0.2px;
      }

      .column-mapping-section p {
        color: var(--neutral-color);
        margin-bottom: 16px;
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .mapping-display {
        background: white;
        padding: 18px;
        border-radius: var(--border-radius);
        margin-bottom: 20px;
        border: 1.5px solid #e0e0e0;
        min-height: 70px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
      }

      .mapping-item {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(
          135deg,
          var(--accent-color) 0%,
          var(--accent-light) 100%
        );
        color: white;
        padding: 10px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: var(--shadow-sm);
      }

      .mapping-item .remove-mapping {
        cursor: pointer;
        font-weight: bold;
        margin-left: 4px;
        font-size: 1.1rem;
        transition: all 0.2s ease;
      }

      .mapping-item .remove-mapping:hover {
        transform: scale(1.2);
        opacity: 0.8;
      }

      .mapping-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      .mapping-column {
        border: 1.5px solid #e0e0e0;
        padding: 18px;
        border-radius: var(--border-radius);
        background: white;
      }

      .mapping-column h6 {
        color: var(--primary-color);
        font-weight: 700;
        margin-bottom: 14px;
        font-size: 0.95rem;
        text-transform: capitalize;
        letter-spacing: 0.2px;
      }

      .mapping-column-item {
        padding: 12px 14px;
        margin-bottom: 8px;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1.5px solid transparent;
        font-weight: 500;
        color: var(--primary-color);
        background: #fafafa;
      }

      .mapping-column-item:hover {
        background-color: #f0f7ff;
        border-color: var(--accent-color);
        transform: translateX(2px);
      }

      .mapping-column-item.selected {
        background: linear-gradient(
          135deg,
          var(--accent-color) 0%,
          var(--accent-light) 100%
        );
        color: white;
        border-color: var(--accent-color);
        font-weight: 600;
        box-shadow: var(--shadow-sm);
      }

      .mapping-help {
        font-size: 0.85rem;
        color: var(--neutral-color);
        margin-top: 12px;
        font-style: italic;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div class="container container-main">
      <div class="page-header">
        <h1><i class="bi bi-graph-up"></i> Salary Comparison Tool</h1>
        <p>
          Compare school salary structures across different districts and
          education levels
        </p>
      </div>

      <!-- Loading states -->
      <div class="loading active" id="loading1">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 mb-0">Loading salary data...</p>
      </div>

      <div class="error-message" id="errorMessage1" role="alert"></div>
      <div class="error-message" id="errorMessage2" role="alert"></div>

      <!-- Comparison Section -->
      <div
        class="comparison-section"
        id="comparisonSection"
        style="display: none"
      >
        <!-- Column Mapping -->
        <div class="table-container">
          <div class="table-header">
            <h3><i class="bi bi-diagram-2"></i> Column Mapping</h3>
          </div>

          <div class="column-mapping-section">
            <h5>Map Salary Types Between Districts</h5>
            <p
              style="
                color: var(--primary-color);
                margin-bottom: 15px;
                font-size: 0.95rem;
              "
            >
              Click a salary type from <strong id="mappingDist1">ECTS</strong>,
              then click a matching type from
              <strong id="mappingDist2">Mercer</strong> to pair them for
              comparison.
            </p>

            <div class="mapping-display" id="mappingDisplay">
              <span style="color: var(--neutral-color); font-style: italic"
                >No mappings yet. Click below to create mappings.</span
              >
            </div>

            <div class="mapping-selector" id="mappingSelector"></div>

            <div class="mapping-help">
              ðŸ’¡ Tip: Map similar degrees with different names (e.g., 'masters'
              from ECTS to 'master_10' from Mercer) to compare them directly.
            </div>
          </div>
        </div>

        <!-- Comparison Results -->
        <div class="table-container">
          <div class="table-header">
            <h3><i class="bi bi-table"></i> Salary Comparison by Step</h3>
          </div>

          <div class="selection-info" id="selectionInfo"></div>

          <div style="overflow-x: auto">
            <table class="table table-hover" id="differenceTable">
              <thead>
                <tr>
                  <th>Position Type</th>
                  <th id="diffHeader1">ECTS Salary</th>
                  <th id="diffHeader2">Mercer Salary</th>
                </tr>
              </thead>
              <tbody id="differenceBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let ectsData = [];
      let comparisonData = [];
      let selectedEctsStep = null;
      let selectedComparisonStep = null;
      let currentType1 = "ECTS";
      let currentType2 = "Mercer";
      let columnMappings = {}; // Maps column1 to column2: { "masters": "bachelors" }
      let selectedMappingColumn1 = null; // Currently selected column from district 1
      let eventListenersAdded = false;

      async function GET(URL) {
        const data = await fetch(URL);
        if (!data.ok) {
          throw new Error(`HTTP error! status: ${data.status}`);
        }
        return data.json();
      }

      function showLoading(id, show = true) {
        document.getElementById(id).classList.toggle("active", show);
      }

      function showError(id, message) {
        const errorEl = document.getElementById(id);
        if (message) {
          errorEl.textContent = `âš ï¸ ${message}`;
          errorEl.classList.add("active");
        } else {
          errorEl.classList.remove("active");
        }
      }

      function updateStatus(id, count) {
        const statusEl = document.getElementById(`status${id}`);
        if (statusEl) {
          statusEl.textContent = `${count} salary steps available`;
        }
      }

      function normalizeNullToZero(value) {
        if (value === null || value === undefined) {
          return 0;
        }
        return value;
      }

      function isValidValue(value) {
        if (value === null || value === undefined || value === 0) {
          return false;
        }
        return true;
      }

      function getNumericFields(row) {
        return Object.keys(row).filter(
          (key) =>
            key !== "step" && !isNaN(parseFloat(row[key])) && row[key] !== null
        );
      }

      function calculateAverageRow(data) {
        if (!Array.isArray(data) || data.length === 0) {
          return null;
        }

        const averageRow = { step: "Average" };
        const fields = getNumericFields(data[0]);

        fields.forEach((field) => {
          const sum = data.reduce((acc, row) => {
            const val = parseFloat(row[field]) || 0;
            return acc + val;
          }, 0);
          averageRow[field] = (sum / data.length).toFixed(2);
        });

        return averageRow;
      }

      function populateTable(data, headerId, bodyId, side) {
        const headerRow = document.getElementById(headerId);
        headerRow.innerHTML = "";

        // Insert average row at the beginning
        const displayData = [calculateAverageRow(data), ...data];

        if (Array.isArray(displayData) && displayData.length > 0) {
          Object.keys(displayData[0]).forEach((key) => {
            const th = document.createElement("th");
            th.textContent = key;
            headerRow.appendChild(th);
          });
        }

        const dataBody = document.getElementById(bodyId);
        dataBody.innerHTML = "";

        if (Array.isArray(displayData)) {
          displayData.forEach((row, index) => {
            const tr = document.createElement("tr");
            tr.style.cursor = "pointer";

            // Auto-select the average row on initial load
            if (index === 0) {
              tr.classList.add("selected");
            }

            Object.values(row).forEach((value) => {
              const td = document.createElement("td");
              td.textContent = value;
              tr.appendChild(td);
            });

            tr.addEventListener("click", () => {
              // Toggle selection instead of replacing
              tr.classList.toggle("selected");
              updateComparison();
            });

            dataBody.appendChild(tr);
          });
        }

        updateStatus(side, data.length);
      }

      function populateMappingSelector() {
        const selector = document.getElementById("mappingSelector");
        if (!selector) return;

        selector.innerHTML = "";

        // Get all rows to find available columns
        if (ectsData.length === 0 || comparisonData.length === 0) return;

        const columns1 = Object.keys(ectsData[0]).filter(
          (key) => key !== "step"
        );
        const columns2 = Object.keys(comparisonData[0]).filter(
          (key) => key !== "step"
        );

        // District 1 columns
        const col1 = document.createElement("div");
        col1.className = "mapping-column";
        col1.innerHTML = `<h6 id="dist1Label">${currentType1} Columns</h6>`;

        columns1.forEach((col) => {
          const item = document.createElement("div");
          item.className = "mapping-column-item";
          item.textContent = col.replace(/_/g, " ");
          item.dataset.column = col;

          if (selectedMappingColumn1 === col) {
            item.classList.add("selected");
          }

          item.addEventListener("click", () => {
            // If same column is clicked again, deselect it
            if (selectedMappingColumn1 === col) {
              selectedMappingColumn1 = null;
              item.classList.remove("selected");
            } else {
              // Deselect previous
              document
                .querySelectorAll(
                  `#mappingSelector .mapping-column:first-child .mapping-column-item`
                )
                .forEach((el) => {
                  el.classList.remove("selected");
                });
              selectedMappingColumn1 = col;
              item.classList.add("selected");
            }
            updateMappingDisplay();
          });

          col1.appendChild(item);
        });

        // District 2 columns
        const col2 = document.createElement("div");
        col2.className = "mapping-column";
        col2.innerHTML = `<h6 id="dist2Label">${currentType2} Columns</h6>`;

        columns2.forEach((col) => {
          const item = document.createElement("div");
          item.className = "mapping-column-item";
          item.textContent = col.replace(/_/g, " ");
          item.dataset.column = col;

          item.addEventListener("click", () => {
            if (selectedMappingColumn1) {
              // Map district 1 column to district 2 column
              columnMappings[selectedMappingColumn1] = col;
              selectedMappingColumn1 = null;

              // Clear selection
              document
                .querySelectorAll(
                  `#mappingSelector .mapping-column:first-child .mapping-column-item`
                )
                .forEach((el) => {
                  el.classList.remove("selected");
                });

              updateMappingDisplay();
              populateMappingSelector();
              updateComparison();
            }
          });

          col2.appendChild(item);
        });

        selector.appendChild(col1);
        selector.appendChild(col2);
      }

      function updateMappingDisplay() {
        const display = document.getElementById("mappingDisplay");
        const mappings = Object.keys(columnMappings);

        if (mappings.length === 0) {
          display.innerHTML = `<span style="color: var(--neutral-color); font-style: italic;">No mappings yet. Click below to create mappings.</span>`;
        } else {
          display.innerHTML = mappings
            .map((col1) => {
              return `<div class="mapping-item">
              <span>${col1.replace(/_/g, " ")} â†’ ${columnMappings[col1].replace(
                /_/g,
                " "
              )}</span>
              <span class="remove-mapping" data-column="${col1}">âœ•</span>
            </div>`;
            })
            .join("");
        }

        // Add event listeners to remove buttons
        document.querySelectorAll(".remove-mapping").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const col1 = e.target.dataset.column;
            removeMapping(col1);
          });
        });
      }

      function removeMapping(col1) {
        delete columnMappings[col1];
        updateMappingDisplay();
        populateMappingSelector();
        updateComparison();
      }

      function calculateSalaryDifference(ectsValue, comparisonValue) {
        const ects = normalizeNullToZero(parseFloat(ectsValue));
        const comp = normalizeNullToZero(parseFloat(comparisonValue));

        if (
          (ects === 0 && !isValidValue(ectsValue)) ||
          (comp === 0 && !isValidValue(comparisonValue))
        ) {
          return { diff: "N/A", percent: "N/A", raw: 0, isNA: true };
        }

        const diff = ects - comp;
        const percent =
          comp !== 0 ? ((diff / comp) * 100).toFixed(2) : diff === 0 ? 0 : "âˆž";
        return {
          diff: diff,
          percent: percent,
          display: `$${Math.abs(diff).toLocaleString()}`,
          raw: diff,
          isNA: false,
        };
      }

      function updateComparison() {
        // Show comparison whenever we have data
        if (ectsData.length === 0 || comparisonData.length === 0) {
          document.getElementById("comparisonSection").style.display = "none";
          return;
        }

        document.getElementById("comparisonSection").style.display = "block";
        document.getElementById("mappingDist1").textContent = currentType1;
        document.getElementById("mappingDist2").textContent = currentType2;

        const differenceBody = document.getElementById("differenceBody");
        differenceBody.innerHTML = "";

        // Use ALL rows from both datasets
        const allEctsRows = ectsData;
        const allCompRows = comparisonData;

        // Get fields from first ECTS row
        const firstEctsRow = allEctsRows[0];
        const fields = getNumericFields(firstEctsRow);

        // Iterate through all ECTS rows
        allEctsRows.forEach((ectsRow) => {
          // Add a section header for each ECTS step
          const stepHeaderTr = document.createElement("tr");
          stepHeaderTr.style.backgroundColor = "#f5f7fa";
          stepHeaderTr.style.fontWeight = "700";
          const stepHeaderTd = document.createElement("td");
          stepHeaderTd.colSpan = 3;
          stepHeaderTd.textContent = `${currentType1} - ${ectsRow.step}`;
          stepHeaderTd.style.padding = "12px 15px";
          stepHeaderTr.appendChild(stepHeaderTd);
          differenceBody.appendChild(stepHeaderTr);

          // Iterate through all comparison rows
          allCompRows.forEach((compRow) => {
            // Add a sub-header for comparison row
            const compHeaderTr = document.createElement("tr");
            compHeaderTr.style.backgroundColor = "#ffffff";
            compHeaderTr.style.fontStyle = "italic";
            compHeaderTr.style.color = "var(--neutral-color)";
            const compHeaderTd = document.createElement("td");
            compHeaderTd.colSpan = 3;
            compHeaderTd.textContent = `  vs ${currentType2} - ${compRow.step}`;
            compHeaderTd.style.padding = "8px 15px";
            compHeaderTr.appendChild(compHeaderTd);
            differenceBody.appendChild(compHeaderTr);

            // Add salary type rows
            fields.forEach((field) => {
              // If mappings exist, use them; otherwise fall back to direct field matching
              let mappedField = columnMappings[field] || field;

              // Skip if mapped field is not in comparison data
              if (!compRow.hasOwnProperty(mappedField)) {
                return;
              }

              const ectsVal = normalizeNullToZero(ectsRow[field]);
              const compVal = normalizeNullToZero(compRow[mappedField]);

              if (ectsVal === 0 && compVal === 0) {
                return;
              }

              const tr = document.createElement("tr");

              const fieldCell = document.createElement("td");
              fieldCell.textContent = field.replace(/_/g, " ");
              fieldCell.style.fontWeight = "600";
              fieldCell.style.paddingLeft = "30px";
              fieldCell.style.width = "25%";
              tr.appendChild(fieldCell);

              const diffData = calculateSalaryDifference(ectsVal, compVal);

              // ECTS salary with inline difference
              const ectsCell = document.createElement("td");
              ectsCell.style.width = "25%";
              if (ectsVal === 0 && !isValidValue(ectsRow[field])) {
                ectsCell.textContent = "N/A";
                ectsCell.style.color = "var(--neutral-color)";
              } else {
                const ectsFormatted = parseFloat(ectsVal).toLocaleString();
                if (diffData.isNA) {
                  ectsCell.innerHTML = `$${ectsFormatted}`;
                } else {
                  let diffClass = "diff-neutral";
                  let diffSymbol = "";
                  if (diffData.raw > 0) {
                    diffClass = "diff-positive";
                    diffSymbol = "+";
                  } else if (diffData.raw < 0) {
                    diffClass = "diff-negative";
                    diffSymbol = "";
                  } else {
                    diffClass = "diff-zero";
                  }
                  ectsCell.innerHTML = `$${ectsFormatted} <span class="${diffClass}"> (${diffSymbol}${diffData.display})</span>`;
                }
              }
              tr.appendChild(ectsCell);

              // Comparison salary with inline difference (reversed sign)
              const compCell = document.createElement("td");
              compCell.style.width = "25%";
              if (compVal === 0 && !isValidValue(compRow[mappedField])) {
                compCell.textContent = "N/A";
                compCell.style.color = "var(--neutral-color)";
              } else {
                const compFormatted = parseFloat(compVal).toLocaleString();
                if (diffData.isNA) {
                  compCell.innerHTML = `$${compFormatted}`;
                } else {
                  let diffClass = "diff-neutral";
                  let diffSymbol = "";
                  if (diffData.raw < 0) {
                    // Reverse the sign for second column
                    diffClass = "diff-positive";
                    diffSymbol = "+";
                    const reversedDiff = Math.abs(diffData.raw);
                    compCell.innerHTML = `$${compFormatted} <span class="${diffClass}"> (+$${reversedDiff.toLocaleString()})</span>`;
                  } else if (diffData.raw > 0) {
                    // Reverse the sign for second column
                    diffClass = "diff-negative";
                    diffSymbol = "";
                    compCell.innerHTML = `$${compFormatted} <span class="${diffClass}"> (-$${diffData.raw.toLocaleString()})</span>`;
                  } else {
                    diffClass = "diff-zero";
                    compCell.innerHTML = `$${compFormatted} <span class="${diffClass}"> ($0)</span>`;
                  }
                }
              }
              tr.appendChild(compCell);

              differenceBody.appendChild(tr);
            });
          });
        });

        if (differenceBody.children.length === 0) {
          const tr = document.createElement("tr");
          tr.classList.add("no-data");
          const td = document.createElement("td");
          td.colSpan = 3;
          td.textContent = "No comparable salary data available.";
          tr.appendChild(td);
          differenceBody.appendChild(tr);
        }
      }

      function populateStepSelects() {
        const ectsSelect = document.getElementById("ectsStepSelect");
        const compSelect = document.getElementById("comparisonStepSelect");

        ectsSelect.innerHTML = "";
        compSelect.innerHTML = "";

        // Add "Average" option first
        const avgOption1 = document.createElement("option");
        avgOption1.value = "Average";
        avgOption1.textContent = "Average (All Rows)";
        ectsSelect.appendChild(avgOption1);

        const avgOption2 = document.createElement("option");
        avgOption2.value = "Average";
        avgOption2.textContent = "Average (All Rows)";
        compSelect.appendChild(avgOption2);

        ectsData.forEach((row) => {
          const option = document.createElement("option");
          option.value = row.step;
          option.textContent = `Step ${row.step}`;
          ectsSelect.appendChild(option);
        });

        comparisonData.forEach((row) => {
          const option = document.createElement("option");
          option.value = row.step;
          option.textContent = `Step ${row.step}`;
          compSelect.appendChild(option);
        });

        // Set default to Average
        ectsSelect.value = "Average";
        compSelect.value = "Average";

        // Remove old listeners and add new ones
        if (!eventListenersAdded) {
          ectsSelect.addEventListener("change", (e) => {
            selectedEctsStep = e.target.value;
            updateComparison();
          });

          compSelect.addEventListener("change", (e) => {
            selectedComparisonStep = e.target.value;
            updateComparison();
          });

          eventListenersAdded = true;
        }

        updateComparison();
      }

      async function loadData(type, side) {
        try {
          showLoading(`loading${side}`, true);
          showError(`errorMessage${side}`, "");
          const data = await GET(`/data?type=${type}`);

          if (side === 1) {
            ectsData = data;
            currentType1 = type;
          } else {
            comparisonData = data;
            currentType2 = type;
          }

          // Both data sets are loaded, so populate mapping and comparison
          if (ectsData.length > 0 && comparisonData.length > 0) {
            populateMappingSelector();
            updateComparison();
          }

          showLoading(`loading${side}`, false);
        } catch (error) {
          console.error(`Error loading data for side ${side}:`, error);
          showError(
            `errorMessage${side}`,
            `Failed to load data: ${error.message}`
          );
          showLoading(`loading${side}`, false);
        }
      }

      async function init() {
        try {
          await loadData("ECTS", 1);
          await loadData("Mercer", 2);
        } catch (error) {
          console.error("Initialization error:", error);
          showError("errorMessage1", "Failed to initialize application");
        }
      }

      init();
    </script>
  </body>
</html>
