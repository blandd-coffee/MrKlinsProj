<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Salary Comparison Tool</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding: 20px;
        background-color: #f8f9fa;
      }
      .header {
        margin-bottom: 30px;
      }
      .controls {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .checklist-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .checklist-section h5 {
        margin-bottom: 15px;
        color: #333;
      }
      .form-check {
        margin-bottom: 10px;
      }
      table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .diff-positive {
        color: #28a745;
        font-weight: 600;
      }
      .diff-negative {
        color: #dc3545;
        font-weight: 600;
      }
      .error-message {
        display: none;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .error-message.active {
        display: block;
      }
      .loading {
        display: none;
        text-align: center;
        padding: 40px;
        color: #666;
      }
      .loading.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Salary Comparison Tool</h1>
        <p>Compare ECTS with other districts</p>
      </div>

      <div class="error-message" id="errorMessage"></div>
      <div class="loading active" id="loading">Loading data...</div>

      <!-- Controls -->
      <div class="controls" id="controls" style="display: none">
        <div class="row">
          <div class="col-md-6">
            <label for="districtSelect" class="form-label"
              >Select District to Compare</label
            >
            <select class="form-select" id="districtSelect">
              <option value="">-- Choose a district --</option>
            </select>
          </div>
        </div>
      </div>

      <!-- ECTS Property Selection -->
      <div
        class="checklist-section"
        id="ectsPropertySection"
        style="display: none"
      >
        <h5>Select ECTS Property to Compare</h5>
        <div id="ectsPropertyRadios"></div>
      </div>

      <!-- Comparison District Property Checklist -->
      <div
        class="checklist-section"
        id="checklistSection"
        style="display: none"
      >
        <h5>Select Properties from <span id="districtName"></span></h5>
        <div id="propertyChecklist"></div>
      </div>

      <!-- Comparison Table -->
      <div id="tableContainer" style="display: none">
        <table class="table table-striped">
          <thead class="table-light">
            <tr id="tableHeader"></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const APP = {
        ectsData: [],
        comparisonData: [],
        selectedDistrict: null,
        selectedEctsProperty: null,
        selectedDistrictProperties: new Set(),
        availableTypes: [],

        async fetchData(type) {
          try {
            const response = await fetch(`/data?type=${type}`);
            if (!response.ok) throw new Error(`Failed to fetch ${type}`);
            return await response.json();
          } catch (error) {
            this.showError(`Failed to load ${type}: ${error.message}`);
            throw error;
          }
        },

        showError(message) {
          const errorEl = document.getElementById("errorMessage");
          errorEl.textContent = `⚠️ ${message}`;
          errorEl.classList.add("active");
        },

        clearError() {
          document.getElementById("errorMessage").classList.remove("active");
        },

        showLoading(show = true) {
          document.getElementById("loading").classList.toggle("active", show);
        },

        async init() {
          try {
            this.showLoading(true);
            const availableResponse = await this.fetchData("");
            this.availableTypes = availableResponse.available || [];

            this.ectsData = await this.fetchData("ECTS");
            this.setupECTSPropertySelection();
            this.setupDistrictSelect();

            document.getElementById("controls").style.display = "block";
            this.showLoading(false);
            this.clearError();
          } catch (error) {
            console.error("Initialization error:", error);
            this.showLoading(false);
          }
        },

        setupECTSPropertySelection() {
          const radioContainer = document.getElementById("ectsPropertyRadios");
          radioContainer.innerHTML = "";

          if (this.ectsData.length === 0) return;

          const firstRow = this.ectsData[0];
          Object.keys(firstRow).forEach((key) => {
            if (key !== "step") {
              const label = document.createElement("label");
              label.className = "form-check-label";

              const radio = document.createElement("input");
              radio.type = "radio";
              radio.className = "form-check-input";
              radio.name = "ectsProperty";
              radio.value = key;

              if (!this.selectedEctsProperty) {
                radio.checked = true;
                this.selectedEctsProperty = key;
              }

              radio.addEventListener("change", (e) => {
                this.selectedEctsProperty = e.target.value;
                this.updateTable();
              });

              label.appendChild(radio);
              label.appendChild(document.createTextNode(` ${key}`));

              const div = document.createElement("div");
              div.className = "form-check";
              div.appendChild(label);
              radioContainer.appendChild(div);
            }
          });

          document.getElementById("ectsPropertySection").style.display =
            "block";
        },

        setupDistrictSelect() {
          const select = document.getElementById("districtSelect");
          this.availableTypes.forEach((type) => {
            if (type !== "ECTS") {
              const option = document.createElement("option");
              option.value = type;
              option.textContent = type;
              select.appendChild(option);
            }
          });

          select.addEventListener("change", async (e) => {
            this.selectedDistrict = e.target.value;
            this.selectedDistrictProperties.clear();
            if (this.selectedDistrict) {
              this.comparisonData = await this.fetchData(this.selectedDistrict);
              document.getElementById("districtName").textContent =
                this.selectedDistrict;
              this.setupDistrictPropertyChecklist();
              document.getElementById("checklistSection").style.display =
                "block";
              this.initializeDistrictProperties();
            } else {
              document.getElementById("checklistSection").style.display =
                "none";
              document.getElementById("tableContainer").style.display = "none";
            }
          });
        },

        setupDistrictPropertyChecklist() {
          const checklist = document.getElementById("propertyChecklist");
          checklist.innerHTML = "";

          if (this.comparisonData.length === 0) return;

          const firstRow = this.comparisonData[0];
          Object.keys(firstRow).forEach((key) => {
            if (key !== "step") {
              const label = document.createElement("label");
              label.className = "form-check-label";

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.className = "form-check-input";
              checkbox.value = key;
              checkbox.checked = true;
              this.selectedDistrictProperties.add(key);

              checkbox.addEventListener("change", (e) => {
                if (e.target.checked) {
                  this.selectedDistrictProperties.add(e.target.value);
                } else {
                  this.selectedDistrictProperties.delete(e.target.value);
                }
                this.updateTable();
              });

              label.appendChild(checkbox);
              label.appendChild(document.createTextNode(` ${key}`));

              const div = document.createElement("div");
              div.className = "form-check";
              div.appendChild(label);
              checklist.appendChild(div);
            }
          });

          this.updateTable();
        },

        initializeDistrictProperties() {
          // All checkboxes are already checked, just update table
          this.updateTable();
        },

        updateTable() {
          if (
            !this.selectedDistrict ||
            !this.selectedEctsProperty ||
            this.ectsData.length === 0
          ) {
            document.getElementById("tableContainer").style.display = "none";
            return;
          }

          this.buildTable();
          document.getElementById("tableContainer").style.display = "block";
        },

        buildTable() {
          // Build header
          const headerRow = document.getElementById("tableHeader");
          headerRow.innerHTML = "";

          const stepTh = document.createElement("th");
          stepTh.textContent = "Step";
          headerRow.appendChild(stepTh);

          const ectsTh = document.createElement("th");
          ectsTh.textContent = `ECTS - ${this.selectedEctsProperty}`;
          headerRow.appendChild(ectsTh);

          this.selectedDistrictProperties.forEach((prop) => {
            const th = document.createElement("th");
            th.textContent = `${this.selectedDistrict} - ${prop}`;
            headerRow.appendChild(th);
          });

          // Build body
          const tableBody = document.getElementById("tableBody");
          tableBody.innerHTML = "";

          this.ectsData.forEach((ectsRow) => {
            const tr = document.createElement("tr");

            const stepTd = document.createElement("td");
            stepTd.textContent = ectsRow.step;
            stepTd.style.fontWeight = "600";
            tr.appendChild(stepTd);

            // ECTS property value
            const ectsValue = ectsRow[this.selectedEctsProperty];
            const ectsTd = document.createElement("td");
            ectsTd.textContent =
              ectsValue !== null && ectsValue !== undefined
                ? `$${parseFloat(ectsValue).toLocaleString()}`
                : "N/A";
            tr.appendChild(ectsTd);

            // Comparison district values with difference
            const compRow = this.comparisonData.find(
              (row) => row.step === ectsRow.step
            );

            this.selectedDistrictProperties.forEach((prop) => {
              const td = document.createElement("td");

              if (!compRow) {
                td.textContent = "N/A";
              } else {
                const ectsBase = parseFloat(ectsRow[this.selectedEctsProperty]);
                const compValue = parseFloat(compRow[prop]);

                if (
                  compValue === null ||
                  compValue === undefined ||
                  isNaN(compValue)
                ) {
                  td.textContent = "N/A";
                } else {
                  const diff = compValue - (ectsBase || 0);
                  const diffDisplay = `$${Math.abs(diff).toLocaleString()}`;

                  if (diff === 0) {
                    td.textContent = `$${compValue.toLocaleString()}`;
                  } else if (diff > 0) {
                    td.innerHTML = `$${compValue.toLocaleString()} <span class="diff-negative">(+${diffDisplay})</span>`;
                  } else {
                    td.innerHTML = `$${compValue.toLocaleString()} <span class="diff-positive">(-${diffDisplay})</span>`;
                  }
                }
              }

              tr.appendChild(td);
            });

            tableBody.appendChild(tr);
          });
        },
      };

      APP.init();
    </script>
  </body>
</html>
