<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Salary Comparison Tool</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding: 20px;
        background-color: #f8f9fa;
      }
      .header {
        margin-bottom: 30px;
      }
      .controls {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .checklist-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .checklist-section h5 {
        margin-bottom: 15px;
        color: #333;
      }
      .form-check {
        margin-bottom: 10px;
      }
      table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .diff-positive {
        color: #28a745;
        font-weight: 600;
      }
      .diff-negative {
        color: #dc3545;
        font-weight: 600;
      }
      .error-message {
        display: none;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .error-message.active {
        display: block;
      }
      .loading {
        display: none;
        text-align: center;
        padding: 40px;
        color: #666;
      }
      .loading.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Salary Comparison Tool</h1>
        <p>Compare ECTS with other districts</p>
      </div>

      <pre id="erieData"></pre>

      <div class="error-message" id="errorMessage"></div>
      <div class="loading active" id="loading">Loading data...</div>

      <!-- Controls -->
      <div class="controls" id="controls" style="display: none">
        <!-- Mode -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Mode</label>
            <select class="form-select" id="modeSelect">
              <option value="single" selected>Single District (current)</option>
              <option value="average">Average of Included Districts</option>
            </select>
          </div>
        </div>

        <!-- Single-mode district select (RESTORED) -->
        <div class="row" id="singleDistrictSection">
          <div class="col-md-6">
            <label for="districtSelect" class="form-label"
              >Select District to Compare</label
            >
            <select class="form-select" id="districtSelect">
              <option value="">-- Choose a district --</option>
            </select>
          </div>
        </div>

        <!-- Average-mode district checklist -->
        <div class="row mt-3" id="avgDistrictSection" style="display: none">
          <div class="col-12">
            <div class="checklist-section">
              <h5>Select Districts to Include in Average</h5>
              <div id="avgDistrictChecklist"></div>
            </div>
          </div>
        </div>

        <!-- Mapping/config UI (shown only when needed) -->
        <div class="row mt-3" id="mappingSection" style="display: none">
          <div class="col-12">
            <div class="checklist-section">
              <h5>One-time Mapping (saved automatically)</h5>
              <p class="text-muted mb-2" style="margin-top: -6px">
                Map each district’s columns to the 4 ECTS properties.
              </p>
              <div id="mappingContainer"></div>
              <button class="btn btn-primary mt-3" id="saveMappingsBtn">
                Save Mappings
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ECTS Property Selection (single mode only) -->
      <div
        class="checklist-section"
        id="ectsPropertySection"
        style="display: none"
      >
        <h5>Select ECTS Property to Compare</h5>
        <div id="ectsPropertyRadios"></div>
      </div>

      <!-- Comparison District Property Checklist (single mode only) -->
      <div
        class="checklist-section"
        id="checklistSection"
        style="display: none"
      >
        <h5>Select Properties from <span id="districtName"></span></h5>
        <div id="propertyChecklist"></div>
      </div>

      <!-- Comparison Table -->
      <div id="tableContainer" style="display: none">
        <table class="table table-striped">
          <thead class="table-light">
            <tr id="tableHeader"></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const APP = {
        ectsData: [],
        comparisonData: [],
        selectedDistrict: null,
        selectedEctsProperty: null,
        selectedDistrictProperties: new Set(),
        availableTypes: [],

        // Modes
        mode: "single", // "single" | "average"
        avgSelectedDistricts: new Set(),
        // IMPORTANT: these must match your ECTS JSON keys
        requiredEctsProps: ["voc_i", "voc_ii", "masters", "m_plus_15"],
        mappings: {}, // loaded from localStorage

        async fetchData(type) {
          try {
            const response = await fetch(`/data/${type}`);
            if (!response.ok) throw new Error(`Failed to fetch ${type}`);
            return await response.json();
          } catch (error) {
            this.showError(`Failed to load ${type}: ${error.message}`);
            throw error;
          }
        },

        showError(message) {
          const errorEl = document.getElementById("errorMessage");
          errorEl.textContent = `⚠️ ${message}`;
          errorEl.classList.add("active");
        },

        clearError() {
          document.getElementById("errorMessage").classList.remove("active");
        },

        showLoading(show = true) {
          document.getElementById("loading").classList.toggle("active", show);
        },

        // ---- Mapping persistence
        loadMappings() {
          try {
            this.mappings = JSON.parse(
              localStorage.getItem("salaryToolMappings") || "{}"
            );
          } catch {
            this.mappings = {};
          }
        },

        saveMappings() {
          localStorage.setItem(
            "salaryToolMappings",
            JSON.stringify(this.mappings)
          );
        },

        getDistrictKey(type) {
          return String(type || "")
            .trim()
            .toLowerCase();
        },

        async init() {
          try {
            this.showLoading(true);

            this.loadMappings();

            const availableResponse = await fetch("/data/types").then((r) =>
              r.json()
            );
            this.availableTypes = availableResponse.available || [];

            this.ectsData = await this.fetchData("ECTS");

            this.setupModeSelect();
            this.setupECTSPropertySelection(); // single mode
            this.setupDistrictSelect(); // single mode
            this.setupAvgDistrictChecklist(); // average mode

            document.getElementById("controls").style.display = "block";
            this.showLoading(false);
            this.clearError();
          } catch (error) {
            console.error("Initialization error:", error);
            this.showLoading(false);
          }
        },

        // ---- Mode switch
        setupModeSelect() {
          const modeSelect = document.getElementById("modeSelect");

          modeSelect.addEventListener("change", (e) => {
            this.mode = e.target.value;

            const avgSection = document.getElementById("avgDistrictSection");
            const mappingSection = document.getElementById("mappingSection");
            const singleDistrictSection = document.getElementById(
              "singleDistrictSection"
            );

            if (this.mode === "average") {
              // Show average UI
              avgSection.style.display = "block";
              singleDistrictSection.style.display = "none";

              // Hide single-mode sections
              document.getElementById("ectsPropertySection").style.display =
                "none";
              document.getElementById("checklistSection").style.display =
                "none";

              // Reset single-mode selection
              document.getElementById("districtSelect").value = "";
              this.selectedDistrict = null;
              this.selectedDistrictProperties.clear();
              this.comparisonData = [];

              // Hide mapping until needed
              mappingSection.style.display = "none";

              // Try to build table
              this.updateTable();
            } else {
              // Back to single mode
              avgSection.style.display = "none";
              mappingSection.style.display = "none";
              singleDistrictSection.style.display = "block";

              // Restore single-mode UI
              document.getElementById("ectsPropertySection").style.display =
                "block";
              document.getElementById("checklistSection").style.display =
                "none";
              document.getElementById("tableContainer").style.display = "none";
            }
          });

          // Save mappings button
          document
            .getElementById("saveMappingsBtn")
            .addEventListener("click", () => {
              const selects = document.querySelectorAll(
                "[data-map-district][data-map-ects]"
              );

              // Validate: nothing left blank
              for (const sel of selects) {
                if (!sel.value) {
                  this.showError(
                    "Please choose a matching district column for every required ECTS property before saving."
                  );
                  return;
                }
              }

              selects.forEach((sel) => {
                const district = sel.getAttribute("data-map-district");
                const ectsProp = sel.getAttribute("data-map-ects");
                const districtProp = sel.value;

                const key = this.getDistrictKey(district);
                if (!this.mappings[key]) this.mappings[key] = {};
                this.mappings[key][ectsProp] = districtProp;
              });

              this.saveMappings();
              this.clearError();
              document.getElementById("mappingSection").style.display = "none";
              this.updateTable();
            });
        },

        // ---- Single mode: ECTS property radios
        setupECTSPropertySelection() {
          const radioContainer = document.getElementById("ectsPropertyRadios");
          radioContainer.innerHTML = "";

          if (this.ectsData.length === 0) return;

          const firstRow = this.ectsData[0];
          const keys = Object.keys(firstRow).filter((k) => k !== "step");

          // pick a default if none
          if (!this.selectedEctsProperty && keys.length) {
            this.selectedEctsProperty = keys[0];
          }

          keys.forEach((key) => {
            const label = document.createElement("label");
            label.className = "form-check-label";

            const radio = document.createElement("input");
            radio.type = "radio";
            radio.className = "form-check-input";
            radio.name = "ectsProperty";
            radio.value = key;
            radio.checked = key === this.selectedEctsProperty;

            radio.addEventListener("change", (e) => {
              this.selectedEctsProperty = e.target.value;
              this.updateTable();
            });

            label.appendChild(radio);
            label.appendChild(document.createTextNode(` ${key}`));

            const div = document.createElement("div");
            div.className = "form-check";
            div.appendChild(label);
            radioContainer.appendChild(div);
          });

          document.getElementById("ectsPropertySection").style.display =
            "block";
        },

        // ---- Single mode: district select
        setupDistrictSelect() {
          const select = document.getElementById("districtSelect");

          // Populate options
          select.innerHTML = `<option value="">-- Choose a district --</option>`;
          this.availableTypes.forEach((type) => {
            if (type !== "ECTS") {
              const option = document.createElement("option");
              option.value = type;
              option.textContent = type;
              select.appendChild(option);
            }
          });

          select.addEventListener("change", async (e) => {
            if (this.mode !== "single") return;

            this.selectedDistrict = e.target.value;
            this.selectedDistrictProperties.clear();

            if (this.selectedDistrict) {
              this.comparisonData = await this.fetchData(this.selectedDistrict);
              document.getElementById("districtName").textContent =
                this.selectedDistrict;
              this.setupDistrictPropertyChecklist();
              document.getElementById("checklistSection").style.display =
                "block";
              this.updateTable();
            } else {
              document.getElementById("checklistSection").style.display =
                "none";
              document.getElementById("tableContainer").style.display = "none";
            }
          });
        },

        setupDistrictPropertyChecklist() {
          const checklist = document.getElementById("propertyChecklist");
          checklist.innerHTML = "";

          if (this.comparisonData.length === 0) return;

          const firstRow = this.comparisonData[0];
          Object.keys(firstRow).forEach((key) => {
            if (key !== "step") {
              const label = document.createElement("label");
              label.className = "form-check-label";

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.className = "form-check-input";
              checkbox.value = key;
              checkbox.checked = true;
              this.selectedDistrictProperties.add(key);

              checkbox.addEventListener("change", (e) => {
                if (e.target.checked)
                  this.selectedDistrictProperties.add(e.target.value);
                else this.selectedDistrictProperties.delete(e.target.value);
                this.updateTable();
              });

              label.appendChild(checkbox);
              label.appendChild(document.createTextNode(` ${key}`));

              const div = document.createElement("div");
              div.className = "form-check";
              div.appendChild(label);
              checklist.appendChild(div);
            }
          });

          this.updateTable();
        },

        // ---- Average mode: district checklist
        setupAvgDistrictChecklist() {
          const container = document.getElementById("avgDistrictChecklist");
          container.innerHTML = "";

          this.availableTypes.forEach((type) => {
            if (type === "ECTS") return;

            const label = document.createElement("label");
            label.className = "form-check-label";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.className = "form-check-input";
            checkbox.value = type;

            checkbox.addEventListener("change", (e) => {
              if (e.target.checked)
                this.avgSelectedDistricts.add(e.target.value);
              else this.avgSelectedDistricts.delete(e.target.value);
              this.updateTable();
            });

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${type}`));

            const div = document.createElement("div");
            div.className = "form-check";
            div.appendChild(label);
            container.appendChild(div);
          });
        },

        // ---- Update table dispatcher
        updateTable() {
          // Clear any stale errors for a smoother experience
          this.clearError();

          if (this.mode === "single") {
            if (
              !this.selectedDistrict ||
              !this.selectedEctsProperty ||
              this.ectsData.length === 0
            ) {
              document.getElementById("tableContainer").style.display = "none";
              return;
            }
            this.buildTableSingle();
            document.getElementById("tableContainer").style.display = "block";
            return;
          }

          // Average mode
          if (
            this.ectsData.length === 0 ||
            this.avgSelectedDistricts.size === 0
          ) {
            document.getElementById("tableContainer").style.display = "none";
            return;
          }

          // buildTableAverage is async; it will hide table if mapping needed
          this.buildTableAverage();
        },

        // ---- Single mode table
        buildTableSingle() {
          const headerRow = document.getElementById("tableHeader");
          headerRow.innerHTML = "";

          const stepTh = document.createElement("th");
          stepTh.textContent = "Step";
          headerRow.appendChild(stepTh);

          const ectsTh = document.createElement("th");
          ectsTh.textContent = `ECTS - ${this.selectedEctsProperty}`;
          headerRow.appendChild(ectsTh);

          this.selectedDistrictProperties.forEach((prop) => {
            const th = document.createElement("th");
            th.textContent = `${this.selectedDistrict} - ${prop}`;
            headerRow.appendChild(th);
          });

          const tableBody = document.getElementById("tableBody");
          tableBody.innerHTML = "";

          this.ectsData.forEach((ectsRow) => {
            const tr = document.createElement("tr");

            const stepTd = document.createElement("td");
            stepTd.textContent = ectsRow.step;
            stepTd.style.fontWeight = "600";
            tr.appendChild(stepTd);

            const ectsValue = ectsRow[this.selectedEctsProperty];
            const ectsTd = document.createElement("td");
            ectsTd.textContent =
              ectsValue !== null && ectsValue !== undefined
                ? `$${parseFloat(ectsValue).toLocaleString()}`
                : "N/A";
            tr.appendChild(ectsTd);

            const compRow = this.comparisonData.find(
              (row) => row.step === ectsRow.step
            );

            this.selectedDistrictProperties.forEach((prop) => {
              const td = document.createElement("td");

              if (!compRow) {
                td.textContent = "N/A";
              } else {
                const ectsBase = parseFloat(ectsRow[this.selectedEctsProperty]);
                const compValue = parseFloat(compRow[prop]);

                if (
                  compValue === null ||
                  compValue === undefined ||
                  Number.isNaN(compValue)
                ) {
                  td.textContent = "N/A";
                } else {
                  const diff = compValue - (ectsBase || 0);
                  const diffDisplay = `$${Math.abs(diff).toLocaleString()}`;

                  // Keeping your existing classes exactly as you had them
                  if (diff === 0) {
                    td.textContent = `$${compValue.toLocaleString()}`;
                  } else if (diff > 0) {
                    td.innerHTML = `$${compValue.toLocaleString()} <span class="diff-negative">(+${diffDisplay})</span>`;
                  } else {
                    td.innerHTML = `$${compValue.toLocaleString()} <span class="diff-positive">(-${diffDisplay})</span>`;
                  }
                }
              }

              tr.appendChild(td);
            });

            tableBody.appendChild(tr);
          });
        },

        // ---- Average mode: ensure mappings exist (show config only when needed)
        async ensureMappingsForSelectedDistricts(districtDataMap) {
          const missing = [];

          for (const type of Object.keys(districtDataMap)) {
            const key = this.getDistrictKey(type);
            const map = this.mappings[key] || {};
            const row0 = districtDataMap[type]?.[0] || {};
            const districtProps = Object.keys(row0).filter((k) => k !== "step");

            const needs = this.requiredEctsProps.filter(
              (ectsProp) =>
                !map[ectsProp] || !districtProps.includes(map[ectsProp])
            );

            if (needs.length) missing.push({ type, needs, districtProps });
          }

          if (missing.length === 0) {
            document.getElementById("mappingSection").style.display = "none";
            return true;
          }

          // Build mapping UI
          const container = document.getElementById("mappingContainer");
          container.innerHTML = "";

          missing.forEach(({ type, needs, districtProps }) => {
            const block = document.createElement("div");
            block.className = "mb-4";
            block.innerHTML = `<div style="font-weight:600; margin-bottom:8px;">${type}</div>`;

            needs.forEach((ectsProp) => {
              const row = document.createElement("div");
              row.className = "row align-items-center mb-2";

              const left = document.createElement("div");
              left.className = "col-md-3";
              left.textContent = ectsProp;

              const right = document.createElement("div");
              right.className = "col-md-9";

              const sel = document.createElement("select");
              sel.className = "form-select";
              sel.setAttribute("data-map-district", type);
              sel.setAttribute("data-map-ects", ectsProp);

              const placeholder = document.createElement("option");
              placeholder.value = "";
              placeholder.textContent = "-- choose matching district column --";
              sel.appendChild(placeholder);

              districtProps.forEach((p) => {
                const opt = document.createElement("option");
                opt.value = p;
                opt.textContent = p;
                sel.appendChild(opt);
              });

              // If we have a mapping but it's invalid, don't preselect.
              // If we have an existing valid mapping, preselect it.
              const key = this.getDistrictKey(type);
              const existing = (this.mappings[key] || {})[ectsProp];
              if (existing && districtProps.includes(existing)) {
                sel.value = existing;
              }

              right.appendChild(sel);
              row.appendChild(left);
              row.appendChild(right);
              block.appendChild(row);
            });

            container.appendChild(block);
          });

          document.getElementById("mappingSection").style.display = "block";
          document.getElementById("tableContainer").style.display = "none";
          return false;
        },

        // ---- Average mode table
        async buildTableAverage() {
          try {
            const districtTypes = Array.from(this.avgSelectedDistricts);

            const districtDataMap = {};
            await Promise.all(
              districtTypes.map(async (type) => {
                districtDataMap[type] = await this.fetchData(type);
              })
            );

            const ok = await this.ensureMappingsForSelectedDistricts(
              districtDataMap
            );
            if (!ok) return;

            // Header: Step + (ECTS + AVG) for each required property
            const headerRow = document.getElementById("tableHeader");
            headerRow.innerHTML = "";

            const stepTh = document.createElement("th");
            stepTh.textContent = "Step";
            headerRow.appendChild(stepTh);

            this.requiredEctsProps.forEach((p) => {
              const th1 = document.createElement("th");
              th1.textContent = `ECTS - ${p}`;
              headerRow.appendChild(th1);

              const th2 = document.createElement("th");
              th2.textContent = `AVG - ${p}`;
              headerRow.appendChild(th2);
            });

            const tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = "";

            const getMappedValue = (districtType, step, ectsProp) => {
              const key = this.getDistrictKey(districtType);
              const mapping = this.mappings[key];
              if (!mapping) return null;

              const districtProp = mapping[ectsProp];
              if (!districtProp) return null;

              const row = (districtDataMap[districtType] || []).find(
                (r) => r.step === step
              );
              if (!row) return null;

              const v = parseFloat(row[districtProp]);
              return Number.isFinite(v) ? v : null;
            };

            this.ectsData.forEach((ectsRow) => {
              const tr = document.createElement("tr");

              const stepTd = document.createElement("td");
              stepTd.textContent = ectsRow.step;
              stepTd.style.fontWeight = "600";
              tr.appendChild(stepTd);

              this.requiredEctsProps.forEach((ectsProp) => {
                const ectsBase = parseFloat(ectsRow[ectsProp]);

                // ECTS cell
                const ectsTd = document.createElement("td");
                ectsTd.textContent = Number.isFinite(ectsBase)
                  ? `$${ectsBase.toLocaleString()}`
                  : "N/A";
                tr.appendChild(ectsTd);

                // AVG cell
                const vals = districtTypes
                  .map((dt) => getMappedValue(dt, ectsRow.step, ectsProp))
                  .filter((v) => v !== null);

                const avgTd = document.createElement("td");

                if (vals.length === 0) {
                  avgTd.textContent = "N/A";
                } else {
                  const avg = Math.round(
                    vals.reduce((a, b) => a + b, 0) / vals.length
                  );

                  if (!Number.isFinite(ectsBase)) {
                    avgTd.textContent = `$${avg.toLocaleString()}`;
                  } else {
                    const diff = avg - ectsBase;
                    const diffDisplay = `$${Math.abs(diff).toLocaleString()}`;

                    if (diff === 0) {
                      avgTd.textContent = `$${avg.toLocaleString()}`;
                    } else if (diff > 0) {
                      avgTd.innerHTML = `$${avg.toLocaleString()} <span class="diff-negative">(+${diffDisplay})</span>`;
                    } else {
                      avgTd.innerHTML = `$${avg.toLocaleString()} <span class="diff-positive">(-${diffDisplay})</span>`;
                    }
                  }
                }

                tr.appendChild(avgTd);
              });

              tableBody.appendChild(tr);
            });

            document.getElementById("tableContainer").style.display = "block";
          } catch (err) {
            console.error(err);
            this.showError(`Average mode failed: ${err.message}`);
            document.getElementById("tableContainer").style.display = "none";
          }
        },
      };

      APP.init();
    </script>
  </body>
</html>
